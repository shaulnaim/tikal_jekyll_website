---
layout: post
title: Hybrid environment setup during migration from SVN to GIT
created: 1350767403
author: miron
permalink: alm/hybrid-environment-setup-during-migration-svn-git
tags:
- ALM
- git
---
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Moving  a +-150 developers dev group from SVN to git is a challenging task.  Management wanted some POC and pilot. Team leaders wanted that the team  agenda and timeline will be taken under consideration. And no one wanted  to decrease productivity more than necessary.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">In  an effort to make everyone happy we established an hybrid SVN-GIT  environment for the transition period. Started on the POC phase and  lasted until the last team was trained and moved to git, this transition  took a little less than a whole year. In this article i will describe  the hybrid environment and working methodologies we use during the  transition period.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Since  we were using a &ldquo;Branch on release&rdquo; methodology, we planned to move  only the trunk to git. Other branches (released versions maintenance  branches) will continue to live in svn. There was very little (if any)  merging from the maintenance branches to trunk and we wanted to keep  things simple. so the main requirements were:</span></p>
<ol style="margin-top:0pt;margin-bottom:0pt;">
    <ol style="margin-top:0pt;margin-bottom:0pt;">
        <li style="list-style-type:lower-alpha;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Every change being pushed to git central repository must be committed to SVN as well.</span></li>
        <li style="list-style-type:lower-alpha;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Git users must have an easy access to SVN commits from within git local repo.</span></li>
        <li style="list-style-type:lower-alpha;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">All developers (both SVN and GIT users) must have an immediate feedback, by email, from jenkins on build-breaking commits.</span></li>
        <li style="list-style-type:lower-alpha;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">There should be a possibility to abandon GIT and move back to SVN without losing any development history.</span></li>
    </ol>
</ol>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">The  resulting environment was made out of 3 repositories: The projects  original SVN repository, A &lsquo;bare&rsquo; GIT repository (git-main.git) that was  the main sync point for all developers that moved to GIT and,  eventually, became the only code repository of the project trunk. And  another git repository that was transparent to developers and functioned  as sync point between SVN and the main GIT repo. I will call it the  &lsquo;git-svn repo&rsquo;. </span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">SVN  server was remote and unavailable for administration. Both GIT  repositories were installed on a RHEL5 server. the git-main repo was  exposed by httpd and ssh to all developers.</span><img width="523" height="558" src="https://lh6.googleusercontent.com/krBqKdXnMrxTjV8FVfwsdrSuoxBebRxLtgfvioiE4rmAUH2wzj-Y6YbFTTtRwgyrDoFjB2exzdDspKis-PN3rhG1Dbwsf5A1UzFoHFAbp7pgqMmw7HQ" alt="" /><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">The &lsquo;git-svn repo&rsquo; was indeed a git-svn clone of the SVN trunk url. It was created using the git-svn tool:</span></p>
<pre class="brush: python;" title="code">
git-svn clone http://svn-server/svn/repo/trunk</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Only trunk was cloned so all git-svn configuration regarding branches and tag handling were unnecessary.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">The  result of the git-svn clone command is a non-bare git repository. It  means that pushing to it is disabled by default. Instead of opening the  repo for push, it was cloned again using:</span></p>
<pre class="brush: python;" title="code">
cd /path/to/git-main/repo
git clone --bare /path/to/git-svn/repo
</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">To  The git-main repository (the new bare repo) we add another branch  &ldquo;work&rdquo; and made it the current (by editing the HEAD file in the bare  repository) this branch was the one all developers were pulling from and  pushing to.<br />
From the developer-using-git point of view, after cloning the git-main repo, there were 2 remote-tracking branches: </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">master</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> and </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">work</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">. </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Work</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> was the one you work on. </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Master</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> was the one representing SVN trunk. Merges from </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">master</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> to </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">work</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> (syncing the changes from SVN trunk to the working git environment) was the developers responsibility and had no automation.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">However, Keeping the </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">master</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> branch synced with the SVN </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">trunk</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> HEAD, and sync the changes pushed to </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">work</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> branch into svn </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:bold;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">trunk</span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"> was the build team responsibility. We did it using a jenkins jobs and a sync script.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">The first job svn2git was polling from SVN (with 1 min time interval) and run a very simple script:</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">(jobs were running inside a jenkins slave on the git server)</span></p>
<pre class="brush: python;" title="code">
#go to the git-svn repo.
cd /path/to/git-svn/repo
#make sure we are on the correct branch
git checkout master
#get SVN latest
git svn rebase
#and push it to the git main repo.
git push -f git-main master:master</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">For this script to run a remote must be defined on the git-svn repo pointing to the git-main repo:</span></p>
<pre class="brush: python;" title="code">
git remote add git-main file:///path/to/git-main/repo</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">That way we kept the master branch synced with the SVN trunk HEAD.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">The second job, git2svn, was polling from git work branch (again every one min) and run this script upon every push: </span></p>
<pre class="brush: python;" title="code">
git-svn-autosync.sh &lt;/path/to/git/repo&gt; &lt;/path/to/git-svn/repo&gt; &lt;branch to sync&gt; &lt;svn tracking branch&gt; &lt;git-repo remote name&gt;</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">The </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">git-svn-autosync.sh </span><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">script  was the heart of the sync infrastructure. It is a spinoff of a (bit  simpler) script i found online. Unfortunately I was not able to find it  again so i can&rsquo;t give a proper credit. Here I will only go over the main  logic of it.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Generally, the script does those tasks (in the git-svn repo context):</span></p>
<ol style="margin-top:0pt;margin-bottom:0pt;">
    <li style="list-style-type:decimal;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Fetches the latest commits from the git-main repository. Using a temporary remote and branch.</span></li>
    <li style="list-style-type:decimal;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Create a log message that document the new commits.</span></li>
    <li style="list-style-type:decimal;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Merge the commits into the master branch (the master is the branch that track SVN trunk)</span></li>
    <li style="list-style-type:decimal;font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;"><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Call git-svn dcommit command that push the new commits to SVN.</span></li>
</ol>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">In more details this is how we do it:</span><br />
<br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">We use &ldquo;die&rdquo; to clean and restore the environment in case of failure (a conflict in merge or rebase is treated as failure):</span></p>
<pre class="brush: python;" title="code">
die() {
       echo &quot;sync-git-to-svn died: $*&quot;
       git rebase --abort  #in case arebase failed
       git branch -D ${TMP_DST_BRANCH} #remove the temp branch we use to sync.
       git remote rm ${TMP_REMOTE_NAME} # Remove the temp remote we use the sync
       git reset --hard ${HEAD_SHA1} #we record the current commit before we start so we can reset to it upon failure.
       exit 1
}</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">All work is done inside the git-svn repo (it is a non bare repo)</span></p>
<pre class="brush: java;" title="code">
cd /path/to/git-svn/repo</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">We  connect to the git-main server and fetch using a temporary remote and  branch. Note that this branch also acts as sort of a mutex. we always  use the same name.</span>&nbsp;</p>
<pre class="brush: python;" title="code">
git remote add  ${TMP_REMOTE_NAME} ${SRC_REPO_PATH} || die 'Could not create remote that point to the git repo'
git branch -v ${TMP_DST_BRANCH} || die 'Could not create temporary working branch, maybe another sync is in progress?'
git fetch -v ${TMP_REMOTE_NAME} +${SRC_BRANCH}:${DST_BRANCH}</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Since  we use merge (as oppose to rebase). Only one new svn commit will be  created for every run of this script (normally for every push to the  git-main repo). This SVN commit owner will be the admin user that cloned  the git-svn repo. We want all the meta information from all the git  commits participating in this push to be inserted to the SVN commit log  message. To do that We have a permanent remote tracking branch that  tracks the work branch. We use it as a pointer to the last commit that  was merged in the previous run of this script.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Now  we use it to list the commits in this merge and gather the meta  information we need.(see git help log for the pretty format syntax)</span></p>
<pre class="brush: python;" title="code">
# we use the --first-parent to filter out merges of master into the working branch.
git log --first-parent --pretty=format:&quot;%h %ae: %n%s%n%b=======&quot; git-main/work..${TMP_DST_BRANCH} &gt; ${MSG_FILE}
#avoid empty logs that will fail merge -m...
echo &quot;====&quot; &gt;&gt; ${MSG_FILE}
</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Now we are ready to merge</span></p>
<pre class="brush: python;" title="code">
# Make sure we work on the correct branch
git checkout  ${SVN_SYNC_BRANCH} || die &quot;Cant checkout svn sync branch.&quot;
# Make sure we uptodate with svn (we do not use git-svn rebase to avoid creation of unnecessary new git commits. git-svn fetch &amp; merge does the trick.
git svn fetch || die &quot;svn fetch failed.&quot;
git merge --ff-only remotes/git-svn || die &quot;Fail to sync ${SVN_SYNC_BRANCH} and svn HEAD&quot;
git merge --no-ff -v -m &quot;$(cat $MSG_FILE)&quot; ${DST_BRANCH} || die &quot;Merge failed. There may be unresolved conflicts.&quot;</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Note  the use of --ff-only in the sync merge. (if it is not ff - something  went wrong and some manually troubleshooting is needed.) And the --no-ff  in the actual merge. We must have a new commit so we can insert the  meta-info in its log message.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">If all went well by now - lets push it to SVN:</span></p>
<pre class="brush: python;" title="code">
git svn dcommit -v  --add-author-from || die &quot;Dcommmit failed.&quot;</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Clean tmp branch and remote</span></p>
<pre class="brush: python;" title="code">
git branch -D ${TMP_DST_BRANCH}
git remote rm ${TMP_REMOTE_NAME}</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">Sync  the (permanent) remote tracking branch. This must be the last thing we  do since we do not want that sync to happen if the script has failed for  any reason.</span></p>
<pre class="brush: python;" title="code">
git fetch -v main-git
exit 0</pre>
<p><span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">As  you can see, every change that was pushed to GIT was committed to SVN  but GIT commits was squashed into one svn commit per push (or per script  run, we did had some failures and the script had to run again on more  than one push). This was acceptable. Every &ldquo;squashed&rdquo; commit was pushed  back to git-main since it was an SVN commit and invoked the svn2git job  when committed. This process created an anomaly because every change  appear twice in GIT history. It was acceptable as well and git merge  treated the anomaly with no issues. Developers using SVN could see the  meta information of a &ldquo;squashed&rdquo; commit by reading the SVN commit log.  The log message was a list of the &ldquo;original&rdquo; GIT commits sha1, committer  and comment.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">We  created 2 jenkins continuous integration jobs. One polling from SVN and  the other from GIT. The nightly build use the sources from SVN.</span><br />
<span style="font-size:15px;color:#000000;background-color:transparent;font-weight:normal;font-style:normal;font-variant:normal;text-decoration:none;vertical-align:baseline;">To  summarize: I do not recommend using Hybrid environment as a standard  development environment. It has too many limitations. But, as a solution  for relatively long transition period It worked for us and enable us to  train and move the teams from SVN to GIT one by one, according to teams  planned timeline with no development downtime and a very small  productivity penalty. &nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<br />
<br />
&nbsp;</p>
<p>&nbsp;</p>
